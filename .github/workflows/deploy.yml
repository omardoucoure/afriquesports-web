name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to DigitalOcean
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script_stop: true
          command_timeout: 30m
          script: |
            set -e  # Exit on any error

            echo "ğŸš€ Starting deployment..."

            # Navigate to project directory
            cd /mnt/volume_nyc1_01/nextjs-apps/afriquesports-web || exit 1

            # Pull latest changes
            echo "ğŸ“¥ Pulling latest code from GitHub..."
            git pull origin main || exit 1

            # Check if package.json changed
            if git diff HEAD@{1} HEAD --name-only | grep -q "package.json"; then
              echo "ğŸ“¦ package.json changed, installing dependencies..."
              npm install --production || exit 1
            else
              echo "âœ“ No dependency changes detected"
            fi

            # Build the application
            echo "ğŸ—ï¸ Building Next.js application..."
            npm run build || exit 1

            # Reload PM2 (graceful restart)
            echo "ğŸ”„ Reloading PM2..."
            pm2 reload ecosystem.config.js --update-env || exit 1

            # Wait for startup
            sleep 5

            # Verify deployment
            echo "âœ… Checking application status..."
            pm2 list
            pm2 info afriquesports-web | grep -E "status|restarts|uptime"

            # Test website
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://www.afriquesports.net)
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Website is responding correctly (200 OK)"
            else
              echo "âŒ Website returned $HTTP_CODE"
              exit 1
            fi

            echo "ğŸ‰ Deployment completed successfully!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi
