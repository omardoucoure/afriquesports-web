#!/usr/bin/env node

/**
 * Post AI-generated match commentary to database
 * Match: Nigeria 2-1 Tanzania (CAN 2025)
 * Generated by: Llama 3.1 70B via RunPod vLLM
 */

const MATCH_ID = '732138';
const LOCALE = 'fr';
const API_ENDPOINT = process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000';
const WEBHOOK_SECRET = process.env.AI_AGENT_WEBHOOK_SECRET;

if (!WEBHOOK_SECRET) {
  console.error('âŒ AI_AGENT_WEBHOOK_SECRET not set in environment');
  process.exit(1);
}

// Commentary events based on Llama 3.1 70B generation
const commentaryEvents = [
  {
    event_id: `${MATCH_ID}_match_start`,
    time: "1'",
    time_seconds: 60,
    text: "Le coup d'envoi est donnÃ© Ã  FÃ¨s ! Nigeria affronte la Tanzanie dans ce match de la CAN 2025. Les Super Eagles, favoris, cherchent Ã  confirmer leur statut aprÃ¨s leur victoire 4-1 contre le Gabon.",
    type: 'matchStart',
    icon: 'âš½',
    is_scoring: false
  },
  {
    event_id: `${MATCH_ID}_tactical_1`,
    time: "12'",
    time_seconds: 720,
    text: "Le Nigeria prend rapidement le contrÃ´le du ballon avec 59% de possession. Leur capacitÃ© Ã  trouver des espaces dans le camp adverse est impressionnante. Les Tanzaniens adoptent une approche dÃ©fensive prudente.",
    type: 'general',
    icon: 'ðŸ“Š',
    is_scoring: false
  },
  {
    event_id: `${MATCH_ID}_save_1`,
    time: "23'",
    time_seconds: 1380,
    text: "Belle parade du gardien tanzanien ! Le Nigeria multiplie les occasions avec dÃ©jÃ  6 tirs cadrÃ©s. La dÃ©fense tanzanienne tient bon grÃ¢ce Ã  un gardien en grande forme.",
    type: 'save',
    team: 'away',
    icon: 'ðŸ§¤',
    is_scoring: false
  },
  {
    event_id: `${MATCH_ID}_corner_1`,
    time: "31'",
    time_seconds: 1860,
    text: "Corner pour le Nigeria ! Les Super Eagles exercent une pression constante sur la dÃ©fense tanzanienne. Leur prÃ©cision technique avec 89,6% de passes rÃ©ussies fait la diffÃ©rence.",
    type: 'corner',
    team: 'home',
    icon: 'ðŸš©',
    is_scoring: false
  },
  {
    event_id: `${MATCH_ID}_half_time`,
    time: "45'",
    time_seconds: 2700,
    text: "Mi-temps Ã  FÃ¨s. Nigeria 0-0 Tanzanie. Match Ã©quilibrÃ© malgrÃ© la domination nigÃ©riane. Les Tanzaniens rÃ©sistent hÃ©roÃ¯quement avec 7 arrÃªts de leur gardien.",
    type: 'halfTime',
    icon: 'â¸ï¸',
    is_scoring: false
  },
  {
    event_id: `${MATCH_ID}_second_half`,
    time: "46'",
    time_seconds: 2760,
    text: "Reprise de la deuxiÃ¨me pÃ©riode ! Les deux Ã©quipes reviennent inchangÃ©es. Le Nigeria doit trouver la faille face Ã  ce mur tanzanien.",
    type: 'general',
    icon: 'â–¶ï¸',
    is_scoring: false
  },
  {
    event_id: `${MATCH_ID}_goal_1`,
    time: "54'",
    time_seconds: 3240,
    text: "BUUUUUT ! OSIMHEN OUVRE LE SCORE POUR LE NIGERIA ! Le chef de file de l'attaque nigÃ©riane reÃ§oit le ballon dans la surface, Ã©limine son dÃ©fenseur et frappe du pied droit. Le ballon file dans la lucarne opposÃ©e ! 1-0 pour les Super Eagles ! Le stade explose !",
    type: 'goal',
    team: 'home',
    player_name: 'Victor Osimhen',
    icon: 'âš½',
    is_scoring: true
  },
  {
    event_id: `${MATCH_ID}_chance_tanzania`,
    time: "61'",
    time_seconds: 3660,
    text: "Occasion manquÃ©e pour la Tanzanie ! Les Taifa Stars ont eu la possibilitÃ© d'Ã©galiser mais la frappe passe juste Ã  cÃ´tÃ©. Les supporters tanzaniens vont regretter cette occasion.",
    type: 'missedChance',
    team: 'away',
    icon: 'ðŸ˜®',
    is_scoring: false
  },
  {
    event_id: `${MATCH_ID}_yellow_card_1`,
    time: "64'",
    time_seconds: 3840,
    text: "Carton jaune pour le Nigeria ! Une faute tactique pour stopper la contre-attaque tanzanienne. Les NigÃ©rians doivent maintenir leur discipline dÃ©fensive.",
    type: 'yellowCard',
    team: 'home',
    icon: 'ðŸŸ¨',
    is_scoring: false
  },
  {
    event_id: `${MATCH_ID}_substitution_1`,
    time: "67'",
    time_seconds: 4020,
    text: "Changement pour le Nigeria ! Alex Iwobi sort, Etebo entre en jeu. Le sÃ©lectionneur nigÃ©rian cherche Ã  consolider l'avance.",
    type: 'substitution',
    team: 'home',
    player_name: 'Alex Etebo',
    icon: 'ðŸ”„',
    is_scoring: false
  },
  {
    event_id: `${MATCH_ID}_goal_2`,
    time: "69'",
    time_seconds: 4140,
    text: "BUUUUUT ! ETEBO INSCRIT UN DOUBLÃ‰ POUR LE NIGERIA ! Deux minutes aprÃ¨s son entrÃ©e en jeu, une frappe splendide du milieu de terrain ! Le ballon vient se loger dans la lucarne ! 2-0 pour les Super Eagles ! Quel impact immÃ©diat !",
    type: 'goal',
    team: 'home',
    player_name: 'Alex Etebo',
    icon: 'âš½',
    is_scoring: true
  },
  {
    event_id: `${MATCH_ID}_tactical_2`,
    time: "72'",
    time_seconds: 4320,
    text: "AprÃ¨s ce deuxiÃ¨me but, le Nigeria gÃ¨re son avance. Les attaques ne sont plus aussi frÃ©quentes et vigoureuses. La Tanzanie doit se montrer plus offensive si elle veut revenir dans le match.",
    type: 'general',
    icon: 'âš¡',
    is_scoring: false
  },
  {
    event_id: `${MATCH_ID}_goal_3`,
    time: "74'",
    time_seconds: 4440,
    text: "BUT POUR LA TANZANIE ! MWANTIKA RÃ‰DUIT LE SCORE ! Le dÃ©fenseur tanzanien surgit sur corner et trompe le gardien nigÃ©rian d'une belle tÃªte ! 2-1 ! Le but de l'honneur ravive l'espoir des Taifa Stars !",
    type: 'goal',
    team: 'away',
    player_name: 'Mwantika',
    icon: 'âš½',
    is_scoring: true
  },
  {
    event_id: `${MATCH_ID}_current_76`,
    time: "76'",
    time_seconds: 4560,
    text: "Ã€ 15 minutes de la fin du match, les NigÃ©rians semblent prÃªts Ã  consolider leur avance. Avec leur domination continue, ils contrÃ´lent les derniÃ¨res minutes. La Tanzanie se mobilise pour tenter une remontÃ©e spectaculaire.",
    type: 'general',
    icon: 'â±ï¸',
    is_scoring: false
  },
  {
    event_id: `${MATCH_ID}_analysis`,
    time: "78'",
    time_seconds: 4680,
    text: "Les statistiques parlent d'elles-mÃªmes : Nigeria avec 59,3% de possession, 18 tirs dont 10 cadrÃ©s, et 89,6% de passes rÃ©ussies. La Tanzanie rÃ©siste avec courage grÃ¢ce Ã  son gardien auteur de 7 arrÃªts.",
    type: 'general',
    icon: 'ðŸ“Š',
    is_scoring: false
  }
];

async function postCommentary() {
  console.log('ðŸŽ™ï¸  Posting AI-generated match commentary to database...');
  console.log(`ðŸ“ Match ID: ${MATCH_ID}`);
  console.log(`ðŸŒ Locale: ${LOCALE}`);
  console.log(`ðŸ’¬ Events: ${commentaryEvents.length}\n`);

  let successCount = 0;
  let errorCount = 0;

  for (const event of commentaryEvents) {
    try {
      const payload = {
        match_id: MATCH_ID,
        locale: LOCALE,
        ...event,
        confidence: 0.95
      };

      const response = await fetch(`${API_ENDPOINT}/api/can2025/live-commentary`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-webhook-secret': WEBHOOK_SECRET
        },
        body: JSON.stringify(payload)
      });

      const result = await response.json();

      if (response.ok) {
        console.log(`âœ… ${event.time} - ${event.type}: ${event.text.substring(0, 60)}...`);
        successCount++;
      } else {
        if (response.status === 409) {
          console.log(`âš ï¸  ${event.time} - Already exists (skipping)`);
        } else {
          console.error(`âŒ ${event.time} - Error: ${result.error}`);
          errorCount++;
        }
      }

      // Small delay to avoid overwhelming the API
      await new Promise(resolve => setTimeout(resolve, 100));

    } catch (error) {
      console.error(`âŒ ${event.time} - Failed:`, error.message);
      errorCount++;
    }
  }

  console.log('\nðŸ“Š Summary:');
  console.log(`   âœ… Success: ${successCount}`);
  console.log(`   âŒ Errors: ${errorCount}`);
  console.log(`   ðŸ“ Total: ${commentaryEvents.length}`);
  console.log('\nðŸŽ¯ View match at: ' + API_ENDPOINT + '/can-2025/match/' + MATCH_ID);
}

// Run the script
postCommentary().catch(error => {
  console.error('Fatal error:', error);
  process.exit(1);
});
