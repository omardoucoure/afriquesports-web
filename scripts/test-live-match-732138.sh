#!/bin/bash

###############################################################################
# Quick Test: Post AI Commentary for Nigeria vs Tanzania (Match 732138)
# Generated by Llama 3.1 70B on RunPod
###############################################################################

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

MATCH_ID="732138"
SITE_URL="${NEXT_PUBLIC_SITE_URL:-http://localhost:3000}"

echo -e "${BLUE}ğŸ™ï¸  Posting AI Commentary for Match ${MATCH_ID}${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

# Check if webhook secret is set
if [ -z "$AI_AGENT_WEBHOOK_SECRET" ]; then
    echo -e "${RED}âŒ Error: AI_AGENT_WEBHOOK_SECRET environment variable not set!${NC}"
    echo -e "${YELLOW}ğŸ’¡ Set it with: export AI_AGENT_WEBHOOK_SECRET='your_secret_here'${NC}\n"
    exit 1
fi

echo -e "${GREEN}âœ… Webhook secret found${NC}"
echo -e "${GREEN}âœ… Target: ${SITE_URL}${NC}\n"

# Function to post a single commentary event
post_event() {
    local EVENT_ID=$1
    local TIME=$2
    local TIME_SEC=$3
    local TEXT=$4
    local TYPE=$5
    local ICON=$6
    local IS_SCORING=$7

    echo -e "${BLUE}ğŸ“ Posting: ${TIME} - ${TEXT:0:60}...${NC}"

    RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
        -X POST "${SITE_URL}/api/can2025/live-commentary" \
        -H "Content-Type: application/json" \
        -H "x-webhook-secret: ${AI_AGENT_WEBHOOK_SECRET}" \
        -d @- <<EOF
{
  "match_id": "${MATCH_ID}",
  "event_id": "${EVENT_ID}",
  "time": "${TIME}",
  "time_seconds": ${TIME_SEC},
  "locale": "fr",
  "text": "${TEXT}",
  "type": "${TYPE}",
  "icon": "${ICON}",
  "is_scoring": ${IS_SCORING},
  "confidence": 0.95
}
EOF
)

    HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS" | cut -d: -f2)
    BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS/d')

    if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "201" ]; then
        echo -e "${GREEN}   âœ… Success${NC}\n"
    elif [ "$HTTP_STATUS" = "409" ]; then
        echo -e "${YELLOW}   âš ï¸  Already exists (skipping)${NC}\n"
    else
        echo -e "${RED}   âŒ Failed (HTTP ${HTTP_STATUS})${NC}"
        echo -e "${RED}   ${BODY}${NC}\n"
    fi

    sleep 0.2  # Small delay between requests
}

# Post all commentary events
echo -e "${BLUE}ğŸ“Š Posting 15 commentary events...${NC}\n"

post_event "${MATCH_ID}_start" "1'" 60 \
    "Le coup d'envoi est donnÃ© Ã  FÃ¨s ! Nigeria affronte la Tanzanie dans ce match de la CAN 2025. Les Super Eagles, favoris, cherchent Ã  confirmer leur statut aprÃ¨s leur victoire 4-1 contre le Gabon." \
    "matchStart" "âš½" false

post_event "${MATCH_ID}_tactical_1" "12'" 720 \
    "Le Nigeria prend rapidement le contrÃ´le du ballon avec 59% de possession. Leur capacitÃ© Ã  trouver des espaces dans le camp adverse est impressionnante. Les Tanzaniens adoptent une approche dÃ©fensive prudente." \
    "general" "ğŸ“Š" false

post_event "${MATCH_ID}_save_1" "23'" 1380 \
    "Belle parade du gardien tanzanien ! Le Nigeria multiplie les occasions avec dÃ©jÃ  6 tirs cadrÃ©s. La dÃ©fense tanzanienne tient bon grÃ¢ce Ã  un gardien en grande forme." \
    "save" "ğŸ§¤" false

post_event "${MATCH_ID}_corner_1" "31'" 1860 \
    "Corner pour le Nigeria ! Les Super Eagles exercent une pression constante sur la dÃ©fense tanzanienne. Leur prÃ©cision technique avec 89,6% de passes rÃ©ussies fait la diffÃ©rence." \
    "corner" "ğŸš©" false

post_event "${MATCH_ID}_ht" "45'" 2700 \
    "Mi-temps Ã  FÃ¨s. Nigeria 0-0 Tanzanie. Match Ã©quilibrÃ© malgrÃ© la domination nigÃ©riane. Les Tanzaniens rÃ©sistent hÃ©roÃ¯quement avec 7 arrÃªts de leur gardien." \
    "halfTime" "â¸ï¸" false

post_event "${MATCH_ID}_2h" "46'" 2760 \
    "Reprise de la deuxiÃ¨me pÃ©riode ! Les deux Ã©quipes reviennent inchangÃ©es. Le Nigeria doit trouver la faille face Ã  ce mur tanzanien." \
    "general" "â–¶ï¸" false

post_event "${MATCH_ID}_goal_osimhen" "54'" 3240 \
    "BUUUUUT ! OSIMHEN OUVRE LE SCORE POUR LE NIGERIA ! Le chef de file de l'attaque nigÃ©riane reÃ§oit le ballon dans la surface, Ã©limine son dÃ©fenseur et frappe du pied droit. Le ballon file dans la lucarne opposÃ©e ! 1-0 pour les Super Eagles ! Le stade explose !" \
    "goal" "âš½" true

post_event "${MATCH_ID}_chance_tz" "61'" 3660 \
    "Occasion manquÃ©e pour la Tanzanie ! Les Taifa Stars ont eu la possibilitÃ© d'Ã©galiser mais la frappe passe juste Ã  cÃ´tÃ©. Les supporters tanzaniens vont regretter cette occasion." \
    "missedChance" "ğŸ˜®" false

post_event "${MATCH_ID}_yellow" "64'" 3840 \
    "Carton jaune pour le Nigeria ! Une faute tactique pour stopper la contre-attaque tanzanienne. Les NigÃ©rians doivent maintenir leur discipline dÃ©fensive." \
    "yellowCard" "ğŸŸ¨" false

post_event "${MATCH_ID}_sub_etebo" "67'" 4020 \
    "Changement pour le Nigeria ! Alex Iwobi sort, Etebo entre en jeu. Le sÃ©lectionneur nigÃ©rian cherche Ã  consolider l'avance." \
    "substitution" "ğŸ”„" false

post_event "${MATCH_ID}_goal_etebo" "69'" 4140 \
    "BUUUUUT ! ETEBO INSCRIT UN DOUBLÃ‰ POUR LE NIGERIA ! Deux minutes aprÃ¨s son entrÃ©e en jeu, une frappe splendide du milieu de terrain ! Le ballon vient se loger dans la lucarne ! 2-0 pour les Super Eagles ! Quel impact immÃ©diat !" \
    "goal" "âš½" true

post_event "${MATCH_ID}_tactical_2" "72'" 4320 \
    "AprÃ¨s ce deuxiÃ¨me but, le Nigeria gÃ¨re son avance. Les attaques ne sont plus aussi frÃ©quentes et vigoureuses. La Tanzanie doit se montrer plus offensive si elle veut revenir dans le match." \
    "general" "âš¡" false

post_event "${MATCH_ID}_goal_mwantika" "74'" 4440 \
    "BUT POUR LA TANZANIE ! MWANTIKA RÃ‰DUIT LE SCORE ! Le dÃ©fenseur tanzanien surgit sur corner et trompe le gardien nigÃ©rian d'une belle tÃªte ! 2-1 ! Le but de l'honneur ravive l'espoir des Taifa Stars !" \
    "goal" "âš½" true

post_event "${MATCH_ID}_min76" "76'" 4560 \
    "Ã€ 15 minutes de la fin du match, les NigÃ©rians semblent prÃªts Ã  consolider leur avance. Avec leur domination continue, ils contrÃ´lent les derniÃ¨res minutes. La Tanzanie se mobilise pour tenter une remontÃ©e spectaculaire." \
    "general" "â±ï¸" false

post_event "${MATCH_ID}_stats" "78'" 4680 \
    "Les statistiques parlent d'elles-mÃªmes : Nigeria avec 59,3% de possession, 18 tirs dont 10 cadrÃ©s, et 89,6% de passes rÃ©ussies. La Tanzanie rÃ©siste avec courage grÃ¢ce Ã  son gardien auteur de 7 arrÃªts." \
    "general" "ğŸ“Š" false

echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ… Commentary posting complete!${NC}\n"
echo -e "${BLUE}ğŸŒ View match at:${NC}"
echo -e "   ${SITE_URL}/can-2025/match/${MATCH_ID}\n"
echo -e "${YELLOW}ğŸ’¡ Tip: Wait 15 seconds for Next.js ISR to revalidate, then refresh the page${NC}\n"
